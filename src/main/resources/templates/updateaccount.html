<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>C·∫≠p nh·∫≠t t√†i kho·∫£n</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    const Status = {
      SUCCESS: "success",
      FAIL: "fail",
      EXCEPTION_FAIL: "fail"
    };

    async function fetchUserData(username) {
      try {
        const response = await fetch(`/api/v1/users/getUserByUsername/${username}`);
        const user = await response.json();

        if (user) {
          document.getElementById('username').value = user.username;
          document.getElementById('email').value = user.email;
          document.getElementById('employee_name').value = user.employee_name || "Kh√¥ng x√°c ƒë·ªãnh"; // S·ª≠a l·ªói hi·ªÉn th·ªã t√™n nh√¢n vi√™n
          document.getElementById('role').value = user.role_name;
          document.getElementById('active').checked = user.status === 'Active';

          // N·∫øu ƒë∆°n v·ªã l√† null th√¨ hi·ªÉn th·ªã "Kh√¥ng x√°c ƒë·ªãnh"
          const departmentSelect = document.getElementById('department');
          const existingOption = document.createElement("option");
          existingOption.value = user.department_name || "";
          existingOption.textContent = user.department_name || "Kh√¥ng x√°c ƒë·ªãnh";
          existingOption.selected = true;
          departmentSelect.appendChild(existingOption);

          // Ch·∫∑n s·ª≠a username & email
          document.getElementById('username').setAttribute('readonly', true);
          document.getElementById('email').setAttribute('readonly', true);

          // Style input readonly
          document.getElementById('username').classList.add('bg-gray-200', 'cursor-not-allowed');
          document.getElementById('email').classList.add('bg-gray-200', 'cursor-not-allowed');
        }
      } catch (error) {
        console.error('L·ªói khi l·∫•y d·ªØ li·ªáu ng∆∞·ªùi d√πng:', error);
      }
    }

    async function fetchDepartments() {
      try {
        const response = await fetch('/api/v1/departments/all');
        const result = await response.json();

        console.log("üìå D·ªØ li·ªáu departments:", result); // Ki·ªÉm tra d·ªØ li·ªáu tr·∫£ v·ªÅ

        if (Array.isArray(result.data)) {
          const departments = [...new Set(result.data.map(item => item.departmentName))]; // Lo·∫°i b·ªè tr√πng l·∫∑p
          populateDepartmentDropdown(departments);
        } else {
          console.error("‚ùå API departments kh√¥ng tr·∫£ v·ªÅ danh s√°ch h·ª£p l·ªá:", result);
        }
      } catch (error) {
        console.error('üö® L·ªói khi l·∫•y danh s√°ch ƒë∆°n v·ªã:', error);
      }
    }

    function populateDepartmentDropdown(departments) {
      const departmentSelect = document.getElementById('department');
      departmentSelect.innerHTML = '<option value="">Ch·ªçn ƒë∆°n v·ªã</option>';
      departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        departmentSelect.appendChild(option);
      });
    }


    async function fetchRoles() {
      try {
        const response = await fetch('/api/v1/roles/all');
        const result = await response.json();
        const rolesString = result.retMsg;
        const roles = rolesString.match(/Role\(roleId=\d+, roleName=(\w+)\)/g).map(role => {
          const roleName = role.match(/roleName=(\w+)/)[1];
          return { roleName };
        });

        const roleSelect = document.getElementById('role');
        roleSelect.innerHTML = '<option>Ch·ªçn quy·ªÅn</option>';
        roles.forEach(role => {
          const option = document.createElement('option');
          option.value = role.roleName;
          option.textContent = role.roleName;
          roleSelect.appendChild(option);
        });
      } catch (error) {
        console.error('L·ªói khi l·∫•y danh s√°ch quy·ªÅn:', error);
      }
    }

    async function updateAccount() {
      const username = document.getElementById('username').value;
      const userData = {
        username,
        employeeName: document.getElementById('employee_name').value,
        email: document.getElementById('email').value,
        departmentId: document.getElementById('department').value,
        role_name: document.getElementById('role').value,
        status: document.getElementById('active').checked ? 'Active' : 'Inactive'
      };

      try {
        const response = await fetch(`/api/v1/users/update/${username}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(userData)
        });
        const result = await response.json();
        alert(result.message);
      } catch (error) {
        console.error('L·ªói khi c·∫≠p nh·∫≠t t√†i kho·∫£n:', error);
        alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau!');
      }
    }

    async function changePassword() {
      const username = document.getElementById('username').value;
      const newPassword = document.getElementById('newPassword').value;

      try {
        const response = await fetch(`/api/v1/users/change-password/${username}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ newPassword })
        });

        const result = await response.json();
        if (result.status === 'SUCCESS') {
          showNotification(result.message);
          window.location.href = "/users";
        } else {
          showNotification(result.message || 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau!');
        }
      } catch (error) {
        console.error('Error:', error);
        showNotification('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau!');
      }
    }

    function resetPassword() {
      document.getElementById('resetPasswordModal').classList.remove('hidden');
    }

    function closePasswordModal() {
      document.getElementById('resetPasswordModal').classList.add('hidden');
    }

    window.onload = async function() {
      const urlParts = window.location.pathname.split('/');
      const username = urlParts[urlParts.length - 1];

      await fetchDepartments();
      await fetchRoles();

      if (username) {
        fetchUserData(username);
      }
      document.querySelector('button.bg-blue-500').addEventListener('click', updateAccount);
      document.querySelector('button.bg-red-500').addEventListener('click', resetPassword);
    };
  </script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
<div class="bg-white p-8 rounded-2xl shadow-md w-96">
  <h2 class="text-xl font-bold mb-4 text-center">C·∫≠p nh·∫≠t t√†i kho·∫£n</h2>
  <form>
    <div class="mb-4">
      <label>Username:</label>
      <input id="username" type="text" class="border border-gray-300 rounded-md p-2 w-full bg-gray-200" readonly>
    </div>
    <div class="mb-4">
      <label>T√™n nh√¢n vi√™n:</label>
      <input id="employee_name" type="text" class="border border-gray-300 rounded-md p-2 w-full">
    </div>
    <div class="mb-4">
      <label>Email:</label>
      <input id="email" type="email" class="border border-gray-300 rounded-md p-2 w-full bg-gray-200" readonly>
    </div>
    <div class="mb-4">
      <label>ƒê∆°n v·ªã:</label>
      <select id="department" class="border border-gray-300 rounded-md p-2 w-full"></select>
    </div>
    <div class="mb-4">
      <label>Quy·ªÅn:</label>
      <select id="role" class="border border-gray-300 rounded-md p-2 w-full"></select>
    </div>
    <div class="mb-4 flex items-center">
      <input type="checkbox" id="active" class="mr-2">
      <label>T√¨nh tr·∫°ng</label>
    </div>
    <div class="flex justify-between mt-4">
      <button type="button" class="bg-blue-500 text-white px-4 py-2 rounded-md">L∆∞u</button>
      <button type="button" class="bg-red-500 text-white px-4 py-2 rounded-md">H·ªßy</button>
      <button type="button" onclick="resetPassword();" class="bg-yellow-500 text-white px-4 py-2 rounded-md">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</button>
    </div>
  </form>
</div>

<!-- M·∫≠t kh·∫©u m·ªõi -->
<div id="resetPasswordModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
  <div class="bg-white p-6 rounded-lg shadow-lg w-80">
    <h2 class="text-xl font-bold mb-4">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</h2>
    <input type="password" id="newPassword" placeholder="M·∫≠t kh·∫©u m·ªõi" class="border border-gray-300 rounded-md p-2 w-full mb-4">
    <div class="flex justify-end">
      <button class="bg-blue-500 text-white px-4 py-2 rounded-md mr-2" onclick="closePasswordModal()">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</button>
      <button class="bg-gray-500 text-white px-4 py-2 rounded-md" onclick="closePasswordModal()">H·ªßy</button>
    </div>
  </div>
</div>
</body>
</html>